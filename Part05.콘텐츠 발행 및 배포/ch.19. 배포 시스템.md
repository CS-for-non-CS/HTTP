# 1. 배포 지원을 위한 FrontPage 서버 확장

`Frontpage`는 마이크로소프트의 웹 개발 및 배포 도구 집합이다. 본래 `버미어 테크놀로지스`에서 만든 것을 1996년 마이크로소프트가 버미어를 인수하면서 1.1 버전을 출시했다. 현재는 2003 버전을 마지막으로 개발이 중단된 상태다.



## 1-1. Frontpage 서버 확장

`어디서든 배포한다`를 전략으로 마이크로소프트는 `Frontpage 서버 확장(Frontpage Server Extensions, FPSE)`라는 서버 측 소프트웨어 제품군을 출시했다. `Frontpage`를 구동시키는 클라이언트와 `FPSE`를 가동시키는 웹 서버 사이에 필요한 변환 작업을 수행한다.

Frontpage 배포 프로토콜은 `HTTP POST` 요청 위에 `RPC 계층`을 구현했다. 이를 이용해 클라이언트는 문서 갱신, 검색, 공동 작업 등을 서버에 요청할 수 있다.



## 1-2. Frontpage 관련 용어

- 가상 서버
  웹 서버 한 개에 웹 사이트 여러 개를 호스팅하는 서버이다.
- 루트 웹
  웹 서버 혹은 가상 웹 서버의 `최상위 콘텐츠 디렉터리`이다. 서버의 URL만 기술하면 접근할 수 있고 웹 서버 한 개당 하나의 루트 웹만이 존재한다.
- 서브 웹
  루트 웹의 혹은 다른 서브 웹의 하위 디렉터리이다. 하나의 독립적인 엔터티로 존재할 수 있으며 검색 범위의 단위로도 사용할 수 있다.



## 1-3. Frontpage RPC 프로토콜

Frontpage 클라이언트와 FPSE는 자체 RPC 프로토콜을 이용해 통신한다. 이 프로토콜은 RPC 메서드와 그와 관련한 변수를 `POST 요청의 본문`에 기술해서 HTTP POST를 감싼다.

통신을 시작하려면 클라이언트는 서버에 있는 대상 `프로그램의 이름`과 `위치`를 결정해야 한다. 이를 위해 클라이언트는 특별한 GET 요청을 보낸다.

클라이언트는 GET 요청에 대한 응답 중 `FPShtmlScriptUrl`, `FPAAuthorScriptUrl`, `FPAdminScriptUrl`와 관련된 값을 찾는다. 순서대로 `탐색 시간(browse time)`, `저작 시간(authoring time)`, `관리 동작`에 관한 POST 요청이 실행되어야 할 위치를 알려준다.



### 요청

POST 요청의 본문에는 `method=<command>` 형식의 RPC 명령과 함께 필요한 모든 매개변수가 기술되어 있다. 대충 아래와 같은 형식이다.

```http
method=list_document:4.0.1.3717
&service_name=
&listHiddenDocs=false
&listExploreDocs=false
```

#### service_name

메서드가 수행되어야 하는 웹 사이트의 URL

#### listHiddenDocs

숨겨진 문서를 보이게 할 지 여부

#### listExploreDocs

태스트 리스트를 나열할 지의 여부



### 응답

일반적으로 성공 메서드나 에러를 반환한다. 어떤 메서드는 `Sample Return Code`를 포함한다.





# 2. WebDAV와 공동 저작

사용자가 HTTP 프로토콜을 이용하여 원격으로 서버에 저장된 파일을 편집하고 관리할 수 있도록 지원해주는 구성이다. 같은 네트워크에 연결되어 있는 것처럼 윈도우 탐색기를 통해 작업할 수 있게 해준다.



## 2-1. WebDAV 메서드

WebDAV는 새로운 HTTP 메서드 집합을 정의했다.

### PROPFIND

리소스의 속성을 읽는다.

### PROPPATCH

한 개 이상의 리소스에 대해 한 개 이상의 속성을 설정한다.

### MKCOL

콜렉션을 생성한다.

### COPY

특정 원본지에서 특정 목적지로 리소스나 리소스의 집합을 복사한다. 원본지와 목적지가 같은 기기일 필요는 없다.

### MOVE

특정 원본지에서 특정 목적지로 리소스나 리소스의 집합을 이동시킨다. 원본지와 목적지가 같은 기기일 필요는 없다.

### LOCK

하나 이상의 리소스를 잠근다.

### UNLOCK

기존에 잠겨있는 리소스를 잠금 해제한다.



## 2-2. WebDAV와 XML

HTTP는 보통 요청과 응답에 관련된 정보를 헤더에 담아 전송한다. 하지만 헤더에만 정보를 담기에는 한계가 있는 것이 사실이다. 이를 보완하기 위해 WebDAV는 `XML(Extensible Markup Language)`을 지원한다.

XML은 구조화된 데이터를 표현할 때 사용하는 포맷으로, `메타 마크업 언어`이다. WebDAV는 XML을 다음과 같은 용도로 사용한다.

- 데이터를 어떻게 처리할 것인지 설명하는 명령 포맷
- 서버의 복잡한 응답을 표현하는 데 사용하는 포맷
- 콜렉션과 리소스를 처리하는 데 사용하는 커스텀 정보 포맷
- 데이터 자체를 표현할 수 있는 유연한 포맷
- 대부분의 국제화 관련 문제에 대한 훌륭한 해결책

XML 문서의 스키마 정의는 XML 문서 내부에서 자체적으로 참조하는 `문서 타입 정의(Document Type Definition, DTD)`를 준수한다. 따라서 XML 문서를 해석하려고 할 때, DOCTYPE 정의 엔터티는 해당 XML 문서와 연관된 `DTD 파일의 이름`을 제공한다.

WebDAV는 `DAV:`라는 별도의 XML `이름공간(namespace)`을 정의한다. 이름공간은 도메인 전체에서 유일한 이름을 보장하기 때문에 충돌을 방지할 수 있다.

또한 이미 정의된 XML 스키마로 인해, 파일을 해석할 필요없이 스키마에서 데이터를 추정할 수 있다.



## 2.3 WebDAV 헤더

WebDAV는 새로운 기능의 헤더들 또한 도입했다.

### DAV

WebDAV를 제공하는 서버와 통신할 때 사용한다. WebDAV에서 지원하는 모든 리소스는 모든 `OPTIONS` 요청에 대한 응답에 이 헤더를 포함해야 한다.

### Depth

여러 수준의 계층 구조로 분류된 리소스에 WebDAV를 사용하기 위한 중요한 요소다. 제공할 디렉터리의 깊이를 정의한다.

### Destination

COPY나 MOVE 메서드가 목적지 URI를 식별하는 데 쓰인다.

### If

조건 집합을 정의한다. 조건부 요청이라고 볼 수 있다.

### Lock-Token

제거되어야 할 잠금을 명시하는 용도로 UNLOCK 메서드에서 사용한다.

### Overwrite

대상을 덮어쓸 것인지 아닌지를 기술할 때 COPY나 MOVE 메서드에서 사용한다.

### Timeout

클라이언트가 필요한 잠금 타임아웃 값을 기술하는 데 사용하는 요청 헤더다.



## 2.4 WebDAV 잠금과 덮어쓰기 방지

WebDAV는 공동 작업의 문제점을 보완하기 위해 `잠금(Lock)`이라는 개념을 지원한다. 총 두 가지 형식의 잠금을 지원한다.

- 리소스나 콜렉션에 대한 배타적 쓰기 잠금
- 리소스나 콜렉션에 대한 공유된 쓰기 잠금

`배타적 쓰기 잠금`은 잠금 소유자만 쓸 수 있다. 잠재적인 충돌을 완벽히 제거할 수 있다. `공유된 쓰기 잠금`은 여러 명으로 구성된 그룹이 하나의 문서에서 작업할 수 있게 한다. 이 잠금 형식은 서로가 서로의 활동을 인식하고 있을 때 잘 동작한다.

WebDAV는 지원할 잠금과 형식을 결정하기 위해, `PROPFIND`를 통해 발견 메커니즘 속성을 제공한다. 또한 저자를 식별하기 위해 `다이제스트 인증`을 요구한다.

잠금이 승인되면, 서버는 도메인 전체에서 유일한 `토큰`을 클라이언트에 반환한다. 이를 `opaquelocktoken 잠금 토큰 URI 스킴`이라 부른다. 그 이후에 클라이언트가 서버에 쓰기 요청을 보내고자 할 때, 다이제스트 인증을 수행한다. 인증이 완료되면 클라이언트는 PUT 요청을 통해 잠금 토큰을 보낸다.



## 2.5 LOCK 메서드

WebDAV는 한 개의 LOCK 요청으로 여러 개의 리소스를 잠글 수 있다. 클라이언트가 서버에 꼭 연결되어 있지 않아도 된다.

### (1) 요청

기본적으로 LOCK 요청은 XML 형태로 전송된다. 전송된 XML은 기본 요소로 `lockinfo`를 가지는데 세 개의 하위 요소가 있다.

#### locktype

잠금 형식을 가리킨다.

#### lockscope

배타적 잠금인지 공유된 잠금인지를 가리킨다.

#### owner

현재 잠금을 가지고 있는 사람을 기술한다.



### (2) 응답

`lockdiscovery` 요소는 잠금에 관한 정보를 담는 컨테이너 역할을 한다. 그 안에 `activelock` 요소가 존재하는데 이 요소는 요청에 담긴 정보 `locktype`, `lockscope`, `owner`를 포함한 다음과 같은 하위 요소를 가진다.

#### locktoken

잠금을 식별하는 데 사용한다. HTTP는 기본적으로 상태가 없기 때문에 이 응답을 받은 이후의 요청에 잠금의 소유자를 식별하는 이 토큰을 보낸다.

#### depth

Depth 헤더와 같은 값을 가진다.

#### timeout

잠금에 대한 타임아웃을 가리킨다.

#### opaquelocktoken 스킴

모든 리소스에 언제든 유일한 토큰을 제공하기 위해 설계되었다. `UUID(universal unique identifier) 메커니즘`을 사용한다.

서버는 각 LOCK 요청에 UUID를 생성하는 방식이나, 한 개의 UUID만 만들고 그 끝에 다른 문자들을 덧붙여서 유일성을 유지하는 방식 중 하나를 선택한다. 성능상 후자가 더 좋지만, 추가된 확장들을 모두 재사용할 수 없다는 단점이 있다.

#### lockdiscovery XML 요소

활성화되어 있는 잠금을 찾는 메커니즘을 제공한다. 이미 잠겨져 있는 파일을 잠그려고 하면, 현재 주인을 가리키는 XML 요소를 응답으로 제공한다. 자체 속성과 함께 아직 처리되지 않은 모든 잠금이 기술된다.

#### 잠금 갱신과 Timeout 헤더

잠금을 갱신하려면, 클라이언트는 If 헤더에 잠금 토큰과 함께 잠금 요청을 다시 보내야 한다. 서버에게 timeout 값을 받는 대신, 클라이언트는 LOCK 요청 안에 필요한 timeout 값을 `Timeout` 헤더에 기술한다. 콤마로 구분해 몇 가지 옵션을 나열한다.

때때론 서버와 잠금 시간을 연동하지 않고 관리자가 직접 리셋하거나 특정 이벤트를 발생시켜 서버가 잠금을 리셋하도록 만들기도 한다.



## 2.6 UNLOCK 메서드

리소스에 있는 잠금을 제거한다. UNLOCK이 성공하기 위한 두 가지 조건이 있는데, `다이제스트 인증`을 성공적으로 완료하는 것과 `Lock-Token` 헤더에 보내는 잠금 토큰에 대한 검사를 통과하는 것이다.

잠금 해제에 성공하면 서버는 `204 No Content` 상태 코드를 반환한다.



## 2.7 속성과 META 데이터

속성에는 저작자의 이름, 수정한 날짜, 내용 등급 등과 같은 리소스의 정보를 기술한다. HTML에서는 META 태그에 이런 정보를 기술하지만 WebDAV와 같은 분산 협업 시스템은 더 복잡한 속성을 기술해야 한다. 이를 지원하기 위해 `PROPFIND`와 `PROPPATCH`라는 두 가지 새로운 메서드를 포함해 HTTP를 확장한다.



## 2.8 PROPFIND 메서드

주어진 파일이나 파일 그룹의 속성을 읽는 데 사용한다. 다음과 같은 세 가지 형식의 동작을 지원한다.

- 모든 속성과 그 값을 요청한다.
- 선택된 속성과 그 값의 집합을 요청한다.
- 모든 속성의 이름을 요청한다.

### (1) 요청

`propfind` 요청 요소는 반환될 속성들을 기술한다. 다음 목록은 PROPFIND 요청과 함께 사용하는 몇몇 XML 요소들을 기술한 것이다.

#### allprop

반환될 모든 속성의 이름과 값을 기술한다. 모든 속성과 그들의 값을 요청하기 위해 `allprop` XML 요소를 보내거나 본문 없이 요청을 보낸다.

#### propname

반환될 속성 이름의 집합을 기술한다.

#### prop

`propfind` 요소의 하위 요소다. 반환될 값의 속성을 기술한다.



### (2) 응답

응답에 있는 XML 요소들은 다음과 같다.

#### multistatus

여러 응답을 담는 컨테이너이다.

#### href

리소스의 URI를 가리킨다.

#### status

특정 요청에 대한 HTTP 상태 코드를 기술한다.

#### propstat

status 요소 한 개와 prop 요소 한 개로 이루어져 있는 집합이다. prop 요소는 리소스에 대한 속성의 이름/값 쌍을 한 개 이상 포함한다.



## 2.9 PROPPATCH 메서드

특정 리소스의 여러 속성을 설정하거나 제거하는 원자적 메커니즘을 제공한다. `원자성`은 모든 요청이 성공하거나 모든 요청이 무효가 되는 둘 중 하나만 수행하는 것을 보장한다.

### (1) 요청

#### propertyupdate

컨테이너 역할을 한다.

#### set

설정할 속성을 기술한다. 한 개 이상의 prop 하위 요소를 포함한다. 이미 존재하는 속성이라면 새로 보내는 값으로 교체된다.

#### remove

제거할 속성을 기술한다. set과는 달리 prop 컨테이너에 속성의 이름만 나열한다.



### (2) 응답

PROPFIND 응답과 매우 유사하다. 한 개 이상의 리소스를 처리할 때 각 객체에 대한 상태는 하나의 `207 Multi-Status` 응답에 합쳐진다. 이는 보통 성공 응답이다.



## 2.10 콜렉션과 이름공간 관리

`콜렉션`은 사전에 정의한 계층에 있는 리소스들의 논리적 혹은 물리적 그룹이다. 디렉터리가 한 예다. 다른 리소스들의 컨테이너처럼 동작하며 다른 콜렉션을 포함하기도 한다.

WebDAV는 XML 이름공간 메커니즘을 사용한다. 전통적인 이름공간과는 달리, 절대 이름공간 충돌이 생기지 않게 하고 명확한 구조적 제어 기능을 제공한다.

WebDAV는 이름공간을 관리하는 다섯 가지 메서드를 제공한다.



## 2.11 MKCOL 메서드

클라이언트가 지정된 URL에 해당하는 콜렉션을 서버에 생성하게 한다. WebDAV 프로토콜의 설계자가 기존의 POST, PUT 메서드를 사용하지 않은 이유는 다음과 같다.

- 클라이언트는 요청 안에 추가적인 정보(semantic glue)를 더하는 식으로 자체적인 프로토콜을 만들어야 한다. 불가능하진 않지만, 번거롭다.
- 대부분의 접근 제어 메커니즘은 `메서드의 타입`에 기반해 동작한다. 만약 다른 메서드들을 본래 용도와 다르게 사용하면 메커니즘이 잘 동작하지 않는다.



## 2.12 DELETE 메서드

콜렉션을 `삭제`할 때 사용한다. 디렉터리를 지우려고 한다면, `Depth` 헤더가 필요하다. Depth 헤더가 없다면, `무한`으로 설정되어 있다고 가정한다. 이는 하위에 있는 모든 디렉터리까지 지워진다는 의미다. 응답의 `Content-Location` 헤더에는 지워진 콜렉션에 대한 정보가 담겨 있다.



## 2.13 COPY와 MOVE 메서드

이 둘의 대안도 기존의 메서드를 이용해 생각해볼 수 있지만, 확장성 등의 문제가 있기 때문에 이를 사용한다. COPY와 MOVE 메서드는 요청 URL을 원본의 위치 정보로 사용하고 목적지인 Destination HTTP 헤더의 값을 목적지 정보로 사용한다.

MOVE 메서드는 COPY 메서드에 이어 몇 가지 추가 작업을 수행한다. 원본의 URL을 목적지에 복사하고, 새로 생성된 URI의 무결성을 검사하고, 원본을 지운다.

이 둘의 메서드도 Depth 헤더의 영향을 받는다.

### Overwrite 헤더의 영향

Overwrite 헤더는 T나 F로 설정할 수 있다. T로 설정하였고 목적지가 존재한다면, COPY나 MOVE 작업을 수행하기 전에 무한대 값을 가진 Depth와 함께 DELETE가 목적지 리소스에 수행될 것이다. F로 설정하였고 목적지가 존재한다면, 작업은 실패할 것이다.

### COPY/MOVE의 속성

콜렉션이나 요소를 복사하면, 기본적으로 그것들의 모든 속성도 복사된다. 하지만 요청 XML에 속성의 복사에 대한 추가 정보를 기술함으로써 조정할 수 있다.

### 잠긴 리소스와 COPY/MOVE

리소스가 잠겨 있으면 리소스를 이동하거나 복제하는 것이 금지된다. 목적지가 현재 잠겨 있는 콜렉션 아래일 경우, 복사 혹은 이동된 리소스도 잠기게 된다.



## 2.14 향상된 HTTP/1.1 메서드

WebDAV는 DELETE, PUT, OPTIONS의 의미를 수정했다. DELETE는 이미 살펴봤으니 PUT과 OPTIONS를 살펴보자.

### PUT 메서드

WebDAV가 따로 정의하지는 않지만, PUT 메서드는 저작자가 공용 사이트에 콘텐츠를 전송하는 유일한 방법이다. WebDAV는 잠금을 지원하기 위해 동작을 수정했다. 잠금을 제공하기 위해 `If` 헤더를 추가했다.

### OPTIONS 메서드

보통 WebDAV를 사용하는 클라이언트가 보내는 첫 요청에 쓰인다. WebDAV 서버가 어떤 것들을 제공하는지 알아볼 수 있다. WebDAV는 응답에 추가적인 헤더를 기술한다.

#### DAV

DAV 지원 클래스에 대한 정보를 제공한다. 두 가지 지원 클래스가 있다.

- Class 1 지원

  서버는 RFC 2518의 모든 절에 있는 모든 MUST 요구사항을 지원해야 한다. 리소스가 Class 1 수준만 지원한다면, DAV 헤더의 값으로 1을 보낸다.

- Class 2 지원
  Class 1을 포함해 추가적으로 LOCK 메서드를 지원한다. 또한 Timeout과 Lock-Token 헤더, supporttedlock과 lockdiscovery XML 요소를 지원해야 한다. Class 2 수준까지 지원한다면, 2를 보낸다.
#### Public

서버에서 지원하는 모든 메서드가 기술되어 있다.

#### Allow

Public 헤더에 기술되어 있는 메서드들의 일부가 기술되어 있다. 해당 리소스에 허락된 메서드들만 기술되어 있다.

#### DASL

SEARCH 메서드에서 사용하는 질의 문법의 형식이 기술되어 있다.



## 2.15 WebDAV의 버전 관리

버저닝은 WebDAV이 생길 당시부터 있진 않았다. 수정한 것이 유실되는 문제를 완전히 막기 위해선 잠금에 더해 버저닝이 필수다. 이와 관련된 기능 중 일부는 접근과 변경에 대해 자세한 내용이 기술된 주석을 관리하는 것이다.

